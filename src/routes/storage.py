"""\nWorkout Storage - In-memory storage with file persistence\n\nFor production, this could be replaced with:\n- SQLite\n- PostgreSQL (Railway addon)\n- Redis\n- JSON file on persistent volume\n"""\n\nfrom datetime import datetime, timedelta\nfrom typing import List\nfrom zoneinfo import ZoneInfo\nimport json\nimport os\n\nDEFAULT_TIMEZONE = "America/Los_Angeles"\n\n\nclass WorkoutStorage:\n    """\n    In-memory workout storage with deduplication.\n    Workouts are keyed by (type, start_time) to prevent duplicates.\n    """\n    \n    def __init__(self):\n        self.workouts = {}  # key: (type, start) -> workout data\n        self._load_from_file()\n    \n    def _get_key(self, workout: dict) -> str:\n        """Generate unique key for workout"""\n        return f"{workout.get('type')}_{workout.get('start')}"\n    \n    def add_workout(self, workout: dict) -> bool:\n        """\n        Add a workout, returns True if new, False if duplicate/updated.\n        """\n        key = self._get_key(workout)\n        is_new = key not in self.workouts\n        self.workouts[key] = workout\n        self._save_to_file()\n        return is_new\n    \n    def get_all(self) -> List[dict]:\n        """Get all workouts sorted by start time (most recent first)"""\n        workouts = list(self.workouts.values())\n        workouts.sort(key=lambda w: w.get("start", ""), reverse=True)\n        return workouts\n    \n    def get_by_date(self, date_str: str) -> List[dict]:\n        """\n        Get workouts for a specific date (YYYY-MM-DD in Pacific time).\n        """\n        result = []\n        for workout in self.workouts.values():\n            start = workout.get("start", "")\n            if start.startswith(date_str):\n                result.append(workout)\n        result.sort(key=lambda w: w.get("start", ""))\n        return result\n    \n    def get_by_type(self, workout_type: str) -> List[dict]:\n        """Get all workouts of a specific type"""\n        result = []\n        for workout in self.workouts.values():\n            if workout.get("type", "").lower() == workout_type.lower():\n                result.append(workout)\n        result.sort(key=lambda w: w.get("start", ""), reverse=True)\n        return result\n    \n    def get_recent(self, days: int = 7) -> List[dict]:\n        """Get workouts from the last N days"""\n        pacific = ZoneInfo(DEFAULT_TIMEZONE)\n        now = datetime.now(pacific)\n        cutoff = now - timedelta(days=days)\n        cutoff_str = cutoff.strftime("%Y-%m-%d")\n        \n        result = []\n        for workout in self.workouts.values():\n            start = workout.get("start", "")\n            # Extract date portion for comparison\n            start_date = start[:10] if len(start) >= 10 else ""\n            if start_date >= cutoff_str:\n                result.append(workout)\n        \n        result.sort(key=lambda w: w.get("start", ""), reverse=True)\n        return result\n    \n    def get_today(self) -> List[dict]:\n        """Get today's workouts (Pacific time)"""\n        pacific = ZoneInfo(DEFAULT_TIMEZONE)\n        today = datetime.now(pacific).strftime("%Y-%m-%d")\n        return self.get_by_date(today)\n    \n    def get_summary(self, days: int = 7) -> dict:\n        """\n        Get workout summary for the last N days.\n        Returns counts by type, total duration, total calories.\n        """\n        workouts = self.get_recent(days)\n        \n        summary = {\n            "period_days": days,\n            "total_workouts": len(workouts),\n            "total_duration_minutes": 0,\n            "total_calories": 0,\n            "by_type": {},\n            "workouts_by_date": {}\n        }\n        \n        for w in workouts:\n            # Count by type\n            wtype = w.get("type", "Unknown")\n            if wtype not in summary["by_type"]:\n                summary["by_type"][wtype] = {\n                    "count": 0,\n                    "total_duration": 0,\n                    "total_calories": 0\n                }\n            summary["by_type"][wtype]["count"] += 1\n            \n            # Duration\n            duration = w.get("duration_minutes") or 0\n            summary["total_duration_minutes"] += duration\n            summary["by_type"][wtype]["total_duration"] += duration\n            \n            # Calories\n            calories = w.get("calories") or 0\n            summary["total_calories"] += calories\n            summary["by_type"][wtype]["total_calories"] += calories\n            \n            # By date\n            start = w.get("start", "")\n            date = start[:10] if len(start) >= 10 else "unknown"\n            if date not in summary["workouts_by_date"]:\n                summary["workouts_by_date"][date] = []\n            summary["workouts_by_date"][date].append({\n                "type": wtype,\n                "duration": duration,\n                "calories": calories\n            })\n        \n        return summary\n    \n    def count(self) -> int:\n        """Get total workout count"""\n        return len(self.workouts)\n    \n    def clear(self) -> int:\n        """Clear all workouts, returns count cleared"""\n        count = len(self.workouts)\n        self.workouts = {}\n        self._save_to_file()\n        return count\n    \n    def _get_storage_path(self) -> str:\n        """Get path for persistent storage file"""\n        return os.getenv("WORKOUT_STORAGE_PATH", "/tmp/workouts.json")\n    \n    def _save_to_file(self):\n        """Save workouts to file for persistence across restarts"""\n        try:\n            path = self._get_storage_path()\n            with open(path, "w") as f:\n                json.dump(list(self.workouts.values()), f, indent=2)\n        except Exception as e:\n            print(f"Warning: Could not save workouts to file: {e}")\n    \n    def _load_from_file(self):\n        """Load workouts from file on startup"""\n        try:\n            path = self._get_storage_path()\n            if os.path.exists(path):\n                with open(path, "r") as f:\n                    workouts = json.load(f)\n                    for w in workouts:\n                        key = self._get_key(w)\n                        self.workouts[key] = w\n                print(f"Loaded {len(self.workouts)} workouts from storage")\n        except Exception as e:\n            print(f"Warning: Could not load workouts from file: {e}")\n\n\n# Singleton instance\nworkout_storage = WorkoutStorage()\n